"""Provided and student written code for Application portion of Module 1."""

import urllib
import matplotlib.pyplot as plt
import random
import proj_1_des as des

#############################################################################
# Provided Code

DATA_URL = "http://storage.googleapis.com/codeskulptor-alg/alg_phys-cite.txt"


def load_graph(graph_url):
    """Load a graph given the URL for a text representation of the graph.

    Returns a dictionary that models a graph
    """
    graph_file = urllib.urlopen(graph_url)
    graph_text = graph_file.read()
    graph_lines = graph_text.split('\n')
    graph_lines = graph_lines[: -1]

    print "Loaded graph with", len(graph_lines), "nodes"

    answer_graph = {}
    for line in graph_lines:
        neighbors = line.split(' ')
        node = int(neighbors[0])
        answer_graph[node] = set([])
        for neighbor in neighbors[1: -1]:
            answer_graph[node].add(int(neighbor))

    return answer_graph


citation_graph = load_graph(DATA_URL)


class DPATrial:
    """Encapsulate optimized trials for DPA algorithm.

    Maintains a list of node numbers with multiple instances of each number.
    The number of instances of each node number are
    in the same proportion as the desired probabilities

    Uses random.choice() to select a node number from this list for each trial.
    """

    def __init__(self, num_nodes):
        """Initialize a DPATrial object.

        DPATrial corresponding to a complete graph with num_nodes nodes

        Note the initial list of node numbers has num_nodes copies of
        each node number
        """
        self._num_nodes = num_nodes
        self._node_numbers = [node for node in range(num_nodes)
                              for dummy_idx in range(num_nodes)]

    def run_trial(self, num_nodes):
        """Conduct num_node trials using by applying random.choice().

        Apply random.choice to the list of node numbers

        Updates the list of node numbers so that the number of instances of
        each node number is in the same ratio as the desired probabilities

        Returns:
        Set of nodes
        """
        # compute the neighbors for the newly-created node
        new_node_neighbors = set()
        for dummy_idx in range(num_nodes):
            new_node_neighbors.add(random.choice(self._node_numbers))

        # update the list of node numbers so that each node number
        # appears in the correct ratio
        self._node_numbers.append(self._num_nodes)
        self._node_numbers.extend(list(new_node_neighbors))

        # update the number of nodes
        self._num_nodes += 1

        return new_node_neighbors


#############################################################################
# Student written code

def make_complete_random_graph(num_nodes, prob):
    """Return a dictionary for a directed graph, based on the given prob."""
    lst = []
    # Creates a list for all possible edges between all nodes
    for node in range(num_nodes):
        dict_val = [idx for idx in range(num_nodes) if idx != node]
        lst.append((node, (dict_val)))

    new_lst = []
    for poss_nodes in lst:
        node_vals = []
        for idx in poss_nodes[1]:  # Looks at the connected nodes for each node
            if random.random() < prob:
                node_vals.append(idx)
        new_lst.append((poss_nodes[0], set(node_vals)))

    return dict(new_lst)


def compute_out_degrees(digraph):
    """Return a dict with the number of out-degree nodes for each node."""
    out_deg_list = []
    for key in digraph.keys():
        count = 0
        for val in digraph[key]:
            count += 1
        out_deg_list.append((key, count))

    return dict(out_deg_list)


def normalized_in_degree_distribution(digraph):
    """Return a normalized distriubtion from a given in_degree_distribution."""
    dist_dict = des.in_degree_distribution(digraph)
    keys = dist_dict.keys()
    denom = sum(dist_dict.values())
    vals_lst = [(idx, (float(dist_dict[idx]) / denom)) for idx in keys]
    return dict(vals_lst)


# dict_list = in_degree_distribution(citation_graph)
dist_list = {0: 4594, 1: 3787, 2: 2699, 3: 1994, 4: 1638, 5: 1327, 6: 1138, 7: 901, 8: 824, 9: 690, 10: 591, 11: 527, 12: 483, 13: 447, 14: 409, 15: 322, 16: 293, 17: 274, 18: 278, 19: 250, 20: 222, 21: 185, 22: 185, 23: 162, 24: 160, 25: 136, 26: 128, 27: 126, 28: 138, 29: 121, 30: 125, 31: 88, 32: 100, 33: 88, 34: 68, 35: 86, 36: 66, 37: 82, 38: 75, 39: 66, 40: 52, 41: 72, 42: 53, 43: 69, 44: 50, 45: 56, 46: 52, 47: 44, 48: 29, 49: 48, 50: 34, 51: 33, 52: 32, 53: 31, 54: 33, 55: 29, 56: 35, 57: 29, 58: 27, 59: 29, 60: 25, 61: 25, 62: 28, 63: 23, 64: 26, 65: 23, 66: 21, 67: 23, 68: 24, 69: 19, 70: 22, 71: 21, 72: 10, 73: 17, 74: 13, 75: 19, 76: 18, 77: 15, 78: 8, 79: 24, 80: 9, 81: 12, 82: 15, 83: 8, 84: 11, 85: 14, 86: 7, 87: 13, 88: 10, 89: 14, 90: 6, 91: 7, 92: 10, 93: 5, 94: 17, 95: 10, 96: 10, 97: 10, 98: 4, 99: 9, 100: 7, 101: 9, 102: 9, 103: 4, 104: 6, 105: 8, 106: 10, 107: 8, 108: 6, 109: 8, 110: 5, 111: 5, 112: 3, 113: 9, 114: 8, 115: 5, 116: 6, 117: 3, 118: 8, 119: 5, 120: 2, 121: 5, 122: 3, 123: 4, 124: 6, 125: 5, 126: 5, 127: 2, 129: 5, 130: 1, 131: 4, 132: 1, 133: 6, 134: 3, 135: 1, 136: 6, 137: 3, 138: 3, 139: 4, 140: 1, 141: 4, 142: 6, 143: 3, 144: 5, 145: 3, 146: 3, 147: 1, 148: 6, 149: 4, 150: 4, 151: 5, 152: 2, 153: 3, 154: 4, 155: 4, 156: 2, 157: 4, 158: 3, 159: 5, 160: 1, 162: 2, 164: 3, 165: 1, 167: 2, 168: 1, 169: 2, 171: 2, 172: 6, 173: 2, 174: 2, 175: 1, 176: 2, 177: 2, 178: 2, 179: 2, 180: 1, 181: 1, 182: 1, 183: 1, 184: 1, 185: 1, 186: 3, 187: 1, 188: 2, 189: 1, 190: 3, 191: 2, 192: 2, 193: 2, 194: 2, 196: 3, 197: 2, 198: 1, 199: 1, 201: 3, 204: 3, 205: 4, 208: 2, 1144: 1, 211: 1, 212: 1, 213: 1, 214: 1, 217: 1, 219: 1, 220: 2, 222: 2, 223: 4, 224: 1, 225: 1, 228: 2, 229: 3, 230: 2, 232: 3, 233: 2, 235: 1, 748: 1, 1775: 1, 240: 1, 242: 2, 244: 1, 247: 2, 251: 1, 252: 1, 1299: 1, 257: 2, 520: 1, 775: 1, 264: 1, 265: 1, 268: 1, 273: 1, 274: 1, 1155: 1, 788: 2, 1032: 1, 282: 2, 290: 1, 295: 1, 297: 1, 301: 3, 304: 1, 308: 1, 314: 1, 315: 1, 651: 1, 325: 2, 701: 1, 327: 2, 328: 2, 329: 2, 331: 1, 333: 1, 337: 1, 340: 1, 341: 1, 344: 1, 347: 1, 1199: 1, 2414: 1, 1641: 1, 373: 1, 807: 1, 380: 2, 383: 1, 385: 1, 388: 1, 1114: 1, 1006: 1, 406: 1, 411: 1, 421: 1, 424: 1, 426: 1, 427: 1, 438: 1, 456: 1, 467: 1, 475: 1, 494: 1}

# normalized_dist_list = normalized_in_degree_distribution(citation_graph)
# 0 key ignored due to taking log of keys (0: 0.16543032048973713)
normalized_dist_list = {1: 0.1363701836514224, 2: 0.09719121353979114, 3: 0.07180410514944184, 4: 0.05898451566438603, 5: 0.047785379906373784, 6: 0.04097947425279078, 7: 0.03244508462369464, 8: 0.029672308246308968, 9: 0.02484695714800144, 10: 0.021281958948505583, 11: 0.01897731364782139, 12: 0.01739287000360101, 13: 0.01609650702196615, 14: 0.014728123874684912, 15: 0.011595246669067338, 16: 0.010550954267194814, 17: 0.009866762693554194, 18: 0.010010803024846956, 19: 0.009002520705797623, 20: 0.00799423838674829, 21: 0.006661865322290242, 22: 0.006661865322290242, 23: 0.0058336334173568595, 24: 0.005761613251710479, 25: 0.004897371263953907, 26: 0.004609290601368383, 27: 0.004537270435722002, 28: 0.004969391429600288, 29: 0.00435722002160605, 30: 0.004501260352898812, 31: 0.0031688872884407635, 32: 0.0036010082823190494, 33: 0.0031688872884407635, 34: 0.0024486856319769533, 35: 0.0030968671227943824, 36: 0.0023766654663305727, 37: 0.0029528267915016203, 38: 0.002700756211739287, 39: 0.0023766654663305727, 40: 0.0018725243068059057, 41: 0.0025927259632697154, 42: 0.001908534389629096, 43: 0.002484695714800144, 44: 0.0018005041411595247, 45: 0.0020165646380986674, 46: 0.0018725243068059057, 47: 0.0015844436442203817, 48: 0.0010442924018725242, 49: 0.0017284839755131436, 50: 0.0012243428159884767, 51: 0.0011883327331652864, 52: 0.0011523226503420958, 53: 0.0011163125675189053, 54: 0.0011883327331652864, 55: 0.0010442924018725242, 56: 0.0012603528988116672, 57: 0.0010442924018725242, 58: 0.0009722722362261433, 59: 0.0010442924018725242, 60: 0.0009002520705797623, 61: 0.0009002520705797623, 62: 0.0010082823190493337, 63: 0.0008282319049333814, 64: 0.0009362621534029529, 65: 0.0008282319049333814, 66: 0.0007562117392870003, 67: 0.0008282319049333814, 68: 0.0008642419877565718, 69: 0.0006841915736406194, 70: 0.0007922218221101909, 71: 0.0007562117392870003, 72: 0.00036010082823190496, 73: 0.0006121714079942383, 74: 0.00046813107670147644, 75: 0.0006841915736406194, 76: 0.0006481814908174289, 77: 0.0005401512423478574, 78: 0.00028808066258552396, 79: 0.0008642419877565718, 80: 0.00032409074540871443, 81: 0.0004321209938782859, 82: 0.0005401512423478574, 83: 0.00028808066258552396, 84: 0.00039611091105509543, 85: 0.0005041411595246669, 86: 0.00025207057976233343, 87: 0.00046813107670147644, 88: 0.00036010082823190496, 89: 0.0005041411595246669, 90: 0.00021606049693914295, 91: 0.00025207057976233343, 92: 0.00036010082823190496, 93: 0.00018005041411595248, 94: 0.0006121714079942383, 95: 0.00036010082823190496, 96: 0.00036010082823190496, 97: 0.00036010082823190496, 98: 0.00014404033129276198, 99: 0.00032409074540871443, 100: 0.00025207057976233343, 101: 0.00032409074540871443, 102: 0.00032409074540871443, 103: 0.00014404033129276198, 104: 0.00021606049693914295, 105: 0.00028808066258552396, 106: 0.00036010082823190496, 107: 0.00028808066258552396, 108: 0.00021606049693914295, 109: 0.00028808066258552396, 110: 0.00018005041411595248, 111: 0.00018005041411595248, 112: 0.00010803024846957148, 113: 0.00032409074540871443, 114: 0.00028808066258552396, 115: 0.00018005041411595248, 116: 0.00021606049693914295, 117: 0.00010803024846957148, 118: 0.00028808066258552396, 119: 0.00018005041411595248, 120: 7.202016564638099e-05, 121: 0.00018005041411595248, 122: 0.00010803024846957148, 123: 0.00014404033129276198, 124: 0.00021606049693914295, 125: 0.00018005041411595248, 126: 0.00018005041411595248, 127: 7.202016564638099e-05, 129: 0.00018005041411595248, 130: 3.6010082823190495e-05, 131: 0.00014404033129276198, 132: 3.6010082823190495e-05, 133: 0.00021606049693914295, 134: 0.00010803024846957148, 135: 3.6010082823190495e-05, 136: 0.00021606049693914295, 137: 0.00010803024846957148, 138: 0.00010803024846957148, 139: 0.00014404033129276198, 140: 3.6010082823190495e-05, 141: 0.00014404033129276198, 142: 0.00021606049693914295, 143: 0.00010803024846957148, 144: 0.00018005041411595248, 145: 0.00010803024846957148, 146: 0.00010803024846957148, 147: 3.6010082823190495e-05, 148: 0.00021606049693914295, 149: 0.00014404033129276198, 150: 0.00014404033129276198, 151: 0.00018005041411595248, 152: 7.202016564638099e-05, 153: 0.00010803024846957148, 154: 0.00014404033129276198, 155: 0.00014404033129276198, 156: 7.202016564638099e-05, 157: 0.00014404033129276198, 158: 0.00010803024846957148, 159: 0.00018005041411595248, 160: 3.6010082823190495e-05, 162: 7.202016564638099e-05, 164: 0.00010803024846957148, 165: 3.6010082823190495e-05, 167: 7.202016564638099e-05, 168: 3.6010082823190495e-05, 169: 7.202016564638099e-05, 171: 7.202016564638099e-05, 172: 0.00021606049693914295, 173: 7.202016564638099e-05, 174: 7.202016564638099e-05, 175: 3.6010082823190495e-05, 176: 7.202016564638099e-05, 177: 7.202016564638099e-05, 178: 7.202016564638099e-05, 179: 7.202016564638099e-05, 180: 3.6010082823190495e-05, 181: 3.6010082823190495e-05, 182: 3.6010082823190495e-05, 183: 3.6010082823190495e-05, 184: 3.6010082823190495e-05, 185: 3.6010082823190495e-05, 186: 0.00010803024846957148, 187: 3.6010082823190495e-05, 188: 7.202016564638099e-05, 189: 3.6010082823190495e-05, 190: 0.00010803024846957148, 191: 7.202016564638099e-05, 192: 7.202016564638099e-05, 193: 7.202016564638099e-05, 194: 7.202016564638099e-05, 196: 0.00010803024846957148, 197: 7.202016564638099e-05, 198: 3.6010082823190495e-05, 199: 3.6010082823190495e-05, 201: 0.00010803024846957148, 204: 0.00010803024846957148, 205: 0.00014404033129276198, 208: 7.202016564638099e-05, 1144: 3.6010082823190495e-05, 211: 3.6010082823190495e-05, 212: 3.6010082823190495e-05, 213: 3.6010082823190495e-05, 214: 3.6010082823190495e-05, 217: 3.6010082823190495e-05, 219: 3.6010082823190495e-05, 220: 7.202016564638099e-05, 222: 7.202016564638099e-05, 223: 0.00014404033129276198, 224: 3.6010082823190495e-05, 225: 3.6010082823190495e-05, 228: 7.202016564638099e-05, 229: 0.00010803024846957148, 230: 7.202016564638099e-05, 232: 0.00010803024846957148, 233: 7.202016564638099e-05, 235: 3.6010082823190495e-05, 748: 3.6010082823190495e-05, 1775: 3.6010082823190495e-05, 240: 3.6010082823190495e-05, 242: 7.202016564638099e-05, 244: 3.6010082823190495e-05, 247: 7.202016564638099e-05, 251: 3.6010082823190495e-05, 252: 3.6010082823190495e-05, 257: 7.202016564638099e-05, 520: 3.6010082823190495e-05, 775: 3.6010082823190495e-05, 264: 3.6010082823190495e-05, 265: 3.6010082823190495e-05, 268: 3.6010082823190495e-05, 273: 3.6010082823190495e-05, 274: 3.6010082823190495e-05, 1299: 3.6010082823190495e-05, 788: 7.202016564638099e-05, 1032: 3.6010082823190495e-05, 282: 7.202016564638099e-05, 290: 3.6010082823190495e-05, 295: 3.6010082823190495e-05, 297: 3.6010082823190495e-05, 301: 0.00010803024846957148, 304: 3.6010082823190495e-05, 308: 3.6010082823190495e-05, 314: 3.6010082823190495e-05, 315: 3.6010082823190495e-05, 651: 3.6010082823190495e-05, 325: 7.202016564638099e-05, 701: 3.6010082823190495e-05, 327: 7.202016564638099e-05, 328: 7.202016564638099e-05, 329: 7.202016564638099e-05, 331: 3.6010082823190495e-05, 333: 3.6010082823190495e-05, 337: 3.6010082823190495e-05, 340: 3.6010082823190495e-05, 341: 3.6010082823190495e-05, 344: 3.6010082823190495e-05, 347: 3.6010082823190495e-05, 1199: 3.6010082823190495e-05, 2414: 3.6010082823190495e-05, 1641: 3.6010082823190495e-05, 373: 3.6010082823190495e-05, 807: 3.6010082823190495e-05, 380: 7.202016564638099e-05, 383: 3.6010082823190495e-05, 385: 3.6010082823190495e-05, 388: 3.6010082823190495e-05, 406: 3.6010082823190495e-05, 1114: 3.6010082823190495e-05, 1006: 3.6010082823190495e-05, 1155: 3.6010082823190495e-05, 411: 3.6010082823190495e-05, 421: 3.6010082823190495e-05, 424: 3.6010082823190495e-05, 426: 3.6010082823190495e-05, 427: 3.6010082823190495e-05, 438: 3.6010082823190495e-05, 456: 3.6010082823190495e-05, 467: 3.6010082823190495e-05, 475: 3.6010082823190495e-05, 494: 3.6010082823190495e-05}


def question_one():
    """Generate graph of log dist percentages vs log dist of bins."""
    x_vals = normalized_dist_list.keys()
    y_vals = normalized_dist_list.values()

    fig = plt.figure()
    ax1 = fig.add_subplot(111)

    ax1.set_xscale('log')
    ax1.set_yscale('log')

    plt.title('Log of Distribution Percentages vs Log of Distribution Bins')
    plt.xlabel('Log of Number of Citations')
    plt.ylabel('Log of Distribution Percentages')

    ax1.scatter(x_vals, y_vals)

    plt.show()


def question_two():
    """Generate graph of normal distribution of in degrees for an ER graph."""
    q2_graph = make_complete_random_graph(1000, .5)
    q2_dict = des.in_degree_distribution(q2_graph)

    fig = plt.figure()
    ax2 = fig.add_subplot(111)

    q2_x = q2_dict.keys()
    q2_y = q2_dict.values()

    plt.title("Normal Distribution of In Degrees for ER graph")
    plt.xlabel("Number of Edges")
    plt.ylabel("Frequency of Occurence")

    ax2.scatter(q2_x, q2_y)

    plt.show()


def question_three():
    """Return the number of edges and number of nodes for the DPA graph."""
    num_edges = 352768 / 27770
    num_nodes = 27770

    return num_edges, num_nodes


def question_four():
    """Generate a graph for log freq vs log number of in degrees for DPA."""
    num_edges = question_three()[0]
    obj = DPATrial(num_edges)

    # Run run_trial from DPATrial class to add nodes and edges
    # Range should actually be n (27770) but changed for speed
    dict_lst = []
    for idx in range(10000):
        dict_lst.append((num_edges, obj.run_trial(13)))
        num_edges += 1

    q4_dict = normalized_in_degree_distribution(dict(dict_lst))
    del q4_dict[0]

    fig = plt.figure()
    ax4 = fig.add_subplot(111)

    q4_x = q4_dict.keys()
    q4_y = q4_dict.values()

    ax4.set_xscale('log')
    ax4.set_yscale('log')

    plt.title('Log Frequency vs Log Number of In Degrees for DPA Graph')
    plt.xlabel("Log of Number of In Degrees")
    plt.ylabel("Log Frequency")

    ax4.scatter(q4_x, q4_y)

    plt.show()
